<div class="weather-modal" tabindex="0" aria-modal="true" role="dialog">

  <!-- Loading overlay -->
  <ng-container *ngIf="isLoadingWeather">
    <div class="loading-overlay">Loading...</div>
  </ng-container>

  <!-- ─────────────────────────────── READY ─────────────────────────────── -->
  <!-- <ng-template #ready> -->
    <header class="wm-header">
      <div class="wm-title-wrapper">
        <h2>{{ station?.name || '-' }}</h2>

        <p class="wm-last-updated-tag" *ngIf="stationWeather?.current?.time as t">
          Last updated at {{ t | date : 'shortTime' }}.
        </p>
      </div>

      <button class="wm-close" (click)="closeModal.emit()" aria-label="Close">
        &times;
      </button>
    </header>

    <!-- Body ──────────────────────────────────────────────────────────── -->
    <section *ngIf="stationWeather" class="wm-body">

      <!-- Quick-stats -->
      <div class="wm-overview">
        <div class="wm-stat wm-forecast">
          <div class="icon">📍</div>
          <div class="value">{{ stationWeather?.sg2hForecast || '–' }}</div>
          <div class="label">2-Hour Forecast</div>
        </div>

        <div class="wm-stat wm-temp">
          <div class="icon">🌡️</div>
          <div class="value">{{ stationWeather?.current?.temperature ?? '–' }} °C</div>
          <div class="label">Temperature</div>
        </div>

        <div class="wm-stat wm-wind">
          <div class="icon">💨</div>
          <div class="value">{{ stationWeather?.current?.windspeed ?? '–' }} km/h</div>
          <div class="label">Wind Speed</div>
        </div>

        <div class="wm-stat wm-direction">
          <div class="icon">🧭</div>
          <div class="value">{{ stationWeather?.current?.winddirection ?? '–' }}°</div>
          <div class="label">Wind Dir.</div>
        </div>
      </div>

      <!-- Extra details -->
      <div class="wm-details">
        <div class="detail-item">
          <strong>Coords:</strong>
          {{
          stationWeather?.latitude !== undefined
          ? (stationWeather?.latitude | number : '1.4-4')
          : '–'
          }},
          {{
          stationWeather?.longitude !== undefined
          ? (stationWeather?.longitude | number : '1.4-4')
          : '–'
          }}
        </div>

        <div class="detail-item">
          <strong>Elevation:</strong> {{ stationWeather?.elevation ?? '–' }} m
        </div>

        <div class="detail-item">
          <strong>Timezone:</strong>
          {{ stationWeather?.timezoneAbbreviation || '–' }}
          (UTC{{ (stationWeather?.utcOffsetSeconds ?? 0) / 3600 | number:'1.0-0' }})
        </div>

        <div class="detail-item">
          <strong>API Latency:</strong>
          {{ stationWeather?.generationtimeMs ?? 0 | number : '1.0-2' }} ms
        </div>
      </div>

      <hr />

      <!-- Hourly chart -->
      <div class="wm-chart">
        <canvas baseChart [data]="lineChartData" [options]="lineChartOptions" [type]="lineChartType">
        </canvas>
      </div>

      <!-- Hourly snapshot -->
      <div class="wm-hourly" *ngIf="stationWeather?.hourly?.time?.length">
        <h3>Next 12 Hours</h3>

        <div class="hourly-grid">
          <ng-container *ngFor="let t of stationWeather?.hourly?.time?.slice(0,12); let i = index">
            <div class="hourly-cell">
              <div class="hour">{{ t | date : 'HH:mm' }}</div>
              <div class="hour-val">
                {{ stationWeather?.hourly?.temperature2m?.[i] ?? '–' }}°
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Debug (dev only) -->
      <details class="wm-debug">
        <summary>[DEBUG] Show JSON Data</summary>
        <pre>{{ stationWeather | json }}</pre>
      </details>

    </section>
  <!-- </ng-template> -->

  <!-- No-data fallback -->
  <div *ngIf="(!isLoadingWeather && !stationWeather)" class="modal-empty">
    ❗ No data available for this station.
  </div>

</div>
